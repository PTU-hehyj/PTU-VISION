<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Camera Stream</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Real-Time Camera Streaming</h1>
        <p>웹캠을 통해 실시간으로 스트리밍된 비디오를 보세요.</p>

        <!-- 카메라 스트리밍을 표시할 비디오 요소 -->
        <video id="videoElement" width="640" height="480" autoplay></video>
        
        <!-- 카메라 스트리밍을 제어하는 버튼들 -->
        <button id="startStream">Start Stream</button>
        <button id="stopStream">Stop Stream</button>
        <button id="switchCamera">Switch Camera</button> <!-- 카메라 전환 버튼 -->
    </div>

    <!-- 카메라 스트리밍을 위한 WebSocket 연결 설정 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.1/socket.io.min.js"></script>
    <script>
        var socket = io.connect('http://localhost:5000');  // 서버 주소로 변경 필요

        // 비디오 스트리밍을 위한 WebRTC
        var videoElement = document.getElementById('videoElement');
        var mediaRecorder;
        var stream;
        var currentCamera = 'user';  // 기본 카메라: 'user' -> 앞면 카메라, 'environment' -> 뒤쪽 카메라

        // 카메라 시작 버튼 클릭 시 카메라 연결
        document.getElementById('startStream').addEventListener('click', function() {
            startCamera(currentCamera);  // 기본 카메라로 스트리밍 시작
        });

        // 카메라 중지 버튼 클릭 시 스트리밍 중지
        document.getElementById('stopStream').addEventListener('click', function() {
            stopCamera();
        });

        // 카메라 전환 버튼 클릭 시 카메라 변경
        document.getElementById('switchCamera').addEventListener('click', function() {
            // 현재 카메라가 'user'(앞면 카메라)일 경우, 'environment'(뒤쪽 카메라)로 변경
            currentCamera = (currentCamera === 'user') ? 'environment' : 'user';
            stopCamera();  // 기존 카메라 끄기
            startCamera(currentCamera);  // 새 카메라로 스트리밍 시작
        });

        // 카메라 시작 함수
        function startCamera(cameraType) {
            navigator.mediaDevices.getUserMedia({
                video: { facingMode: cameraType }
            })
            .then(function(gottenStream) {
                stream = gottenStream;
                videoElement.srcObject = stream;

                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = function(event) {
                    socket.emit('camera_stream', event.data);  // WebSocket으로 비디오 데이터 전송
                };
                mediaRecorder.start(100);  // 100ms마다 데이터 전송
                document.getElementById('statusMessage').innerText = "Streaming started...";
            })
            .catch(function(err) {
                console.log("Error accessing camera: ", err);
                document.getElementById('statusMessage').innerText = "Error accessing camera.";
            });
        }

        // 카메라 중지 함수
        function stopCamera() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                stream.getTracks().forEach(track => track.stop());  // 카메라 끄기
                videoElement.srcObject = null;  // 비디오 끄기
                document.getElementById('statusMessage').innerText = "Streaming stopped.";
            }
        }

        // 서버로부터의 메시지 수신 및 상태 업데이트
        socket.on('message', function(data) {
            console.log(data);
            document.getElementById('statusMessage').innerText = data.data;
        });
    </script>
</body>
</html>
